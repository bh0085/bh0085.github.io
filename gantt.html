<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Actions Gantt Chart</title>
    <script type="module">
      import { requireAuth } from './auth.js';
      requireAuth();
    </script>
    <script>
        // Cloudflare Worker URL
        const WORKER_URL = 'https://black-math-16d7.ben-2e3.workers.dev';
    </script>
    <style>
        .home-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #7f8c8d;
            text-decoration: underline;
            font-size: 14px;
        }
        .home-link:hover {
            color: #2c3e50;
            text-decoration: none;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f7f7f7;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .meta {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .priority-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .priority-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 500;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .priority-tab:hover {
            color: #2c3e50;
        }
        
        .priority-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .filters-accordion {
            margin-bottom: 20px;
        }
        
        .filters-toggle {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .filters-toggle:hover {
            background: #e9ecef;
        }
        
        .filters-content {
            display: none;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background: white;
        }
        
        .filters-content.open {
            display: block;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }
        
        .filter-group select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .gantt-container {
            overflow-x: auto;
            margin-top: 20px;
            padding-top: 30px;
            position: relative;
        }
        
        .timeline {
            position: relative;
            min-width: 100%;
        }
        
        .timeline-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            border-left: 2px dashed #bdc3c7;
            pointer-events: none;
            z-index: 5;
        }
        
        .timeline-label {
            position: absolute;
            top: -25px;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            color: #7f8c8d;
            white-space: nowrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }
        
        .status-ind-in-progress { background: #3498db; }
        .status-ind-not-started { background: #95a5a6; }
        .status-ind-completed { background: #2ecc71; }
        .status-ind-delayed { background: #e74c3c; }
        .status-ind-on-hold { background: #f39c12; }
        
        .task-row {
            display: flex;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid #ecf0f1;
            position: relative;
        }
        
        .task-row:hover {
            background: #f8f9fa;
        }
        
        .task-label {
            width: 300px;
            flex-shrink: 0;
            padding-right: 20px;
        }
        
        .task-name {
            font-weight: 500;
            color: #2c3e50;
            font-size: 12px;
            margin-bottom: 0;
        }
        
        .task-info {
            font-size: 10px;
            color: #95a5a6;
        }
        
        .timeline-track {
            flex: 1;
            position: relative;
            height: 24px;
        }
        
        .task-bar {
            position: absolute;
            height: 18px;
            border-radius: 3px;
            top: 3px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            padding: 0 6px;
            font-size: 9px;
            color: white;
            font-weight: 500;
        }
        
        .task-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .user-0 { background: #9b59b6; }
        .user-1 { background: #3498db; }
        .user-2 { background: #2ecc71; }
        .user-3 { background: #e67e22; }
        .user-4 { background: #e74c3c; }
        .user-5 { background: #1abc9c; }
        .user-6 { background: #f39c12; }
        .user-7 { background: #34495e; }
        .user-unassigned { background: #95a5a6; }
        
        /* Category colors matching Notion */
        .category-partnerships { background: #2ecc71; }
        .category-operations { background: #e67e22; }
        .category-technology { background: #f39c12; }
        .category-branding { background: #95a5a6; }
        .category-pre-raise { background: #e91e63; }
        .category-ga-fundraising { background: #e74c3c; }
        .category-default { background: #95a5a6; }
        
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 6px;
        }
        
        .status-in-progress { background: #3498db; color: white; }
        .status-not-started { background: #95a5a6; color: white; }
        .status-completed { background: #2ecc71; color: white; }
        .status-delayed { background: #e74c3c; color: white; }
        .status-on-hold { background: #f39c12; color: white; }
        
        .tooltip {
            position: fixed;
            background: #2c3e50;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .tooltip-title {
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .tooltip-row {
            margin: 3px 0;
        }
    </style>
</head>
<body>
    <a href="/" class="home-link">← home</a>
    <div class="container">
        <h1>Key Actions Gantt Chart</h1>
        <div class="meta" id="meta"></div>
        
        <!-- Priority Tabs -->
        <div class="priority-tabs">
            <button class="priority-tab active" onclick="setPriorityFilter('')">All Tasks</button>
            <button class="priority-tab" onclick="setPriorityFilter('Fundraising')">Fundraising Priority</button>
        </div>
        
        <div class="gantt-container">
            <div class="timeline" id="timeline"></div>
        </div>
        
        <!-- Advanced Settings at Bottom -->
        <div class="filters-accordion" style="margin-top: 30px;">
            <div class="filters-toggle" onclick="toggleFilters()">
                <span>⚙️ Advanced Settings</span>
                <span id="filters-arrow">▼</span>
            </div>
            <div class="filters-content" id="filters-content">
                <div class="filters">
                    <div class="filter-group">
                        <label for="categoryFilter">Category:</label>
                        <select id="categoryFilter">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="statusFilter">Status:</label>
                        <select id="statusFilter">
                            <option value="">All Statuses</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="ownerFilter">Owner:</label>
                        <select id="ownerFilter">
                            <option value="">All People</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <button onclick="refreshFromNotion()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">↻ Force Refresh from Notion</button>
                    <span style="margin-left: 10px; font-size: 12px; color: #7f8c8d;">Data auto-refreshes from cache on page load</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        let ganttData = null;
        let filteredTasks = [];
        let currentPriorityFilter = '';
        
        function toggleFilters() {
            const content = document.getElementById('filters-content');
            const arrow = document.getElementById('filters-arrow');
            content.classList.toggle('open');
            arrow.textContent = content.classList.contains('open') ? '▲' : '▼';
        }
        
        function setPriorityFilter(priority) {
            currentPriorityFilter = priority;
            
            // Update active tab
            document.querySelectorAll('.priority-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterAndRender();
        }
        
        // Fetch data from Cloudflare Worker (which handles Notion API + transformation)
        async function fetchFromWorker(forceRefresh = false) {
            const url = forceRefresh ? `${WORKER_URL}?refresh=true` : WORKER_URL;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Worker returned ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        async function refreshFromNotion() {
            const btn = event.target;
            btn.textContent = '⟳ Fetching from Notion...';
            btn.disabled = true;
            
            try {
                ganttData = await fetchFromWorker(true); // Force refresh
                
                document.getElementById('meta').textContent = 
                    `${ganttData.task_count} tasks • Live from Notion • ${new Date().toLocaleString()}`;
                
                populateFilters();
                filterAndRender();
                
                btn.textContent = '✓ Refreshed!';
                setTimeout(() => {
                    btn.textContent = '↻ Refresh from Notion';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Refresh error:', error);
                btn.textContent = `✗ Error: ${error.message}`;
                setTimeout(() => {
                    btn.textContent = '↻ Refresh from Notion';
                    btn.disabled = false;
                }, 3000);
            }
        }
        
        async function loadData() {
            try {
                // Fetch from cache (fast) - worker handles 1-hour cache TTL
                ganttData = await fetchFromWorker(false);
                
                const lastUpdate = new Date(ganttData.exported_at);
                const cacheAge = Math.round((Date.now() - lastUpdate) / 60000); // minutes
                
                document.getElementById('meta').textContent = 
                    `${ganttData.task_count} tasks • Updated ${cacheAge}m ago`;
                
                populateFilters();
                filterAndRender();
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('meta').textContent = 
                    `Error loading data: ${error.message}`;
            }
        }
        
        function populateFilters() {
            const categories = [...new Set(ganttData.tasks.map(t => t.category).filter(Boolean))];
            const statuses = [...new Set(ganttData.tasks.map(t => t.status).filter(Boolean))];
            const owners = [...new Set(ganttData.tasks.map(t => t.owner).filter(Boolean))];
            
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            
            const statusFilter = document.getElementById('statusFilter');
            statusFilter.innerHTML = '<option value="">All Statuses</option>';
            statuses.sort().forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });
            
            const ownerFilter = document.getElementById('ownerFilter');
            ownerFilter.innerHTML = '<option value="">All People</option>';
            owners.sort().forEach(owner => {
                const option = document.createElement('option');
                option.value = owner;
                option.textContent = owner;
                ownerFilter.appendChild(option);
            });
            
            categoryFilter.addEventListener('change', filterAndRender);
            statusFilter.addEventListener('change', filterAndRender);
            ownerFilter.addEventListener('change', filterAndRender);
        }
        
        function filterAndRender() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const ownerFilter = document.getElementById('ownerFilter').value;
            
            filteredTasks = ganttData.tasks.filter(task => {
                if (categoryFilter && task.category !== categoryFilter) return false;
                if (statusFilter && task.status !== statusFilter) return false;
                if (currentPriorityFilter && task.priority !== currentPriorityFilter) return false;
                if (ownerFilter && task.owner !== ownerFilter) return false;
                return task.start_date && task.end_date;
            });
            
            filteredTasks.sort((a, b) => {
                const catCompare = (a.category || '').localeCompare(b.category || '');
                if (catCompare !== 0) return catCompare;
                return (a.start_date || '').localeCompare(b.start_date || '');
            });
            
            renderGantt();
        }
        
        function renderGantt() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                timeline.innerHTML = '<p style="padding: 20px; text-align: center; color: #7f8c8d;">No tasks match the selected filters</p>';
                return;
            }
            
            // Extend date range: 2 weeks back from today, 60+ days forward
            const today = new Date();
            const twoWeeksAgo = new Date(today);
            twoWeeksAgo.setDate(today.getDate() - 14);
            
            const dates = filteredTasks.flatMap(t => [t.start_date, t.end_date]).filter(Boolean);
            const taskMinDate = new Date(Math.min(...dates.map(d => new Date(d))));
            const taskMaxDate = new Date(Math.max(...dates.map(d => new Date(d))));
            
            // Use earliest of 2 weeks ago or first task
            const minDate = taskMinDate < twoWeeksAgo ? taskMinDate : twoWeeksAgo;
            // Use latest of 60 days from now or last task
            const sixtyDaysOut = new Date(today);
            sixtyDaysOut.setDate(today.getDate() + 60);
            const maxDate = taskMaxDate > sixtyDaysOut ? taskMaxDate : sixtyDaysOut;
            
            const totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24);
            
            // Add timeline markers
            const todayOffset = ((today - minDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
            const twoWeeksOffset = ((new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000) - minDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
            const sixtyDaysOffset = ((sixtyDaysOut - minDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
            
            addTimelineMarker(timeline, todayOffset, 'Today');
            addTimelineMarker(timeline, twoWeeksOffset, '2 Weeks');
            addTimelineMarker(timeline, sixtyDaysOffset, '60 Days');
            
            filteredTasks.forEach(task => {
                const row = document.createElement('div');
                row.className = 'task-row';
                
                const label = document.createElement('div');
                label.className = 'task-label';
                
                const ownerText = task.owner || 'Unassigned';
                const statusClass = getStatusClass(task.status);
                
                label.innerHTML = `
                    <div class="task-name">${task.name || 'Untitled'}</div>
                    <div class="task-info">${ownerText}<span class="status-indicator ${statusClass}"></span></div>
                `;
                
                const track = document.createElement('div');
                track.className = 'timeline-track';
                
                const startDate = new Date(task.start_date);
                const endDate = new Date(task.end_date);
                const startOffset = ((startDate - minDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                const duration = ((endDate - startDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                
                const bar = document.createElement('div');
                bar.className = 'task-bar';
                bar.style.left = `${startOffset}%`;
                bar.style.width = `${Math.max(duration, 2)}%`;
                bar.style.background = getCategoryColor(task);
                
                const progress = task.progress ? Math.round(task.progress * 100) : 0;
                bar.textContent = progress > 0 ? `${progress}%` : '';
                
                bar.addEventListener('mouseenter', (e) => showTooltip(e, task));
                bar.addEventListener('mouseleave', hideTooltip);
                bar.addEventListener('click', () => openNotionPage(task.id));
                
                track.appendChild(bar);
                row.appendChild(label);
                row.appendChild(track);
                timeline.appendChild(row);
            });
        }
        
        function addTimelineMarker(timeline, position, label) {
            const marker = document.createElement('div');
            marker.className = 'timeline-marker';
            marker.style.left = `${position}%`;
            
            const markerLabel = document.createElement('div');
            markerLabel.className = 'timeline-label';
            markerLabel.textContent = label;
            markerLabel.style.left = `${position}%`;
            
            timeline.appendChild(marker);
            timeline.appendChild(markerLabel);
        }
        
        function getStatusClass(status) {
            if (!status) return 'status-ind-not-started';
            const normalized = status.toLowerCase().replace(/\s+/g, '-');
            return `status-ind-${normalized}`;
        }
        
        function getCategoryColor(task) {
            // Use color directly from Notion API (via worker)
            if (task.category_color) {
                return task.category_color;
            }
            // Fallback to default gray
            return '#95a5a6';
        }
        
        const userColors = {};
        let userColorIndex = 0;
        
        function getUserClass(task) {
            if (!task.owner) return 'unassigned';
            
            if (!(task.owner in userColors)) {
                userColors[task.owner] = userColorIndex % 8;
                userColorIndex++;
            }
            return userColors[task.owner];
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        function showTooltip(e, task) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 15) + 'px';
            tooltip.style.top = (e.pageY + 15) + 'px';
            
            let content = `<div class="tooltip-title">${task.name || 'Untitled'}</div>`;
            if (task.category) content += `<div class="tooltip-row"><strong>Category:</strong> ${task.category}</div>`;
            if (task.status) content += `<div class="tooltip-row"><strong>Status:</strong> ${task.status}</div>`;
            if (task.priority) content += `<div class="tooltip-row"><strong>Priority:</strong> ${task.priority}</div>`;
            if (task.start_date) content += `<div class="tooltip-row"><strong>Start:</strong> ${formatDate(task.start_date)}</div>`;
            if (task.end_date) content += `<div class="tooltip-row"><strong>End:</strong> ${formatDate(task.end_date)}</div>`;
            if (task.owner) {
                content += `<div class="tooltip-row"><strong>Owner:</strong> ${task.owner}</div>`;
            }
            if (task.contributors && task.contributors.length > 0) {
                content += `<div class="tooltip-row"><strong>Contributors:</strong> ${task.contributors.join(', ')}</div>`;
            }
            if (task.one_time_cost) content += `<div class="tooltip-row"><strong>One-Time Cost:</strong> $${task.one_time_cost.toLocaleString()}</div>`;
            if (task.monthly_cost) content += `<div class="tooltip-row"><strong>Monthly Cost:</strong> $${task.monthly_cost.toLocaleString()}/mo</div>`;
            if (task.progress) content += `<div class="tooltip-row"><strong>Progress:</strong> ${Math.round(task.progress * 100)}%</div>`;
            content += `<div class="tooltip-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-style: italic; opacity: 0.8;">Click to open in Notion →</div>`;
            
            tooltip.innerHTML = content;
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }
        
        function openNotionPage(pageId) {
            if (!pageId) return;
            // Convert Notion page ID to URL format (remove dashes)
            const cleanId = pageId.replace(/-/g, '');
            const notionUrl = `https://www.notion.so/${cleanId}`;
            window.open(notionUrl, '_blank');
        }
        
        loadData();
    </script>
</body>
</html>

