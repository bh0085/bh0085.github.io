<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Actions Gantt Chart</title>
    <script type="module">
      import { requireAuth } from './auth.js';
      requireAuth();
    </script>
    <style>
        .home-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #7f8c8d;
            text-decoration: underline;
            font-size: 14px;
        }
        .home-link:hover {
            color: #2c3e50;
            text-decoration: none;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f7f7f7;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .meta {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .filters {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .filter-group select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .gantt-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .timeline {
            position: relative;
            min-width: 100%;
        }
        
        .task-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #ecf0f1;
            position: relative;
        }
        
        .task-row:hover {
            background: #f8f9fa;
        }
        
        .task-label {
            width: 300px;
            flex-shrink: 0;
            padding-right: 20px;
        }
        
        .task-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .task-info {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .timeline-track {
            flex: 1;
            position: relative;
            height: 40px;
        }
        
        .task-bar {
            position: absolute;
            height: 28px;
            border-radius: 4px;
            top: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            color: white;
            font-weight: 500;
        }
        
        .task-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .category-fundraising { background: #9b59b6; }
        .category-technology { background: #3498db; }
        .category-milestones { background: #2ecc71; }
        .category-ops { background: #e67e22; }
        .category-work { background: #34495e; }
        .category-default { background: #95a5a6; }
        
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 6px;
        }
        
        .status-in-progress { background: #3498db; color: white; }
        .status-not-started { background: #95a5a6; color: white; }
        .status-completed { background: #2ecc71; color: white; }
        .status-delayed { background: #e74c3c; color: white; }
        .status-on-hold { background: #f39c12; color: white; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .tooltip {
            position: fixed;
            background: #2c3e50;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .tooltip-title {
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .tooltip-row {
            margin: 3px 0;
        }
    </style>
</head>
<body>
    <a href="/" class="home-link">← home</a>
    <div class="container">
        <h1>Key Actions Gantt Chart</h1>
        <div class="meta" id="meta"></div>
        
        <div class="filters">
            <div class="filter-group">
                <label for="categoryFilter">Category:</label>
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter">
                    <option value="">All Statuses</option>
                </select>
            </div>
        </div>
        
        <div class="gantt-container">
            <div class="timeline" id="timeline"></div>
        </div>
        
        <div class="stats" id="stats"></div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        let ganttData = null;
        let filteredTasks = [];
        
        async function loadData() {
            const response = await fetch('gantt_data.json');
            ganttData = await response.json();
            
            document.getElementById('meta').textContent = 
                `${ganttData.task_count} tasks • Exported ${new Date(ganttData.exported_at).toLocaleString()}`;
            
            populateFilters();
            filterAndRender();
            renderStats();
        }
        
        function populateFilters() {
            const categories = [...new Set(ganttData.tasks.map(t => t.category).filter(Boolean))];
            const statuses = [...new Set(ganttData.tasks.map(t => t.status).filter(Boolean))];
            
            const categoryFilter = document.getElementById('categoryFilter');
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            
            const statusFilter = document.getElementById('statusFilter');
            statuses.sort().forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });
            
            categoryFilter.addEventListener('change', filterAndRender);
            statusFilter.addEventListener('change', filterAndRender);
        }
        
        function filterAndRender() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredTasks = ganttData.tasks.filter(task => {
                if (categoryFilter && task.category !== categoryFilter) return false;
                if (statusFilter && task.status !== statusFilter) return false;
                return task.start_date && task.end_date;
            });
            
            filteredTasks.sort((a, b) => {
                const catCompare = (a.category || '').localeCompare(b.category || '');
                if (catCompare !== 0) return catCompare;
                return (a.start_date || '').localeCompare(b.start_date || '');
            });
            
            renderGantt();
        }
        
        function renderGantt() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                timeline.innerHTML = '<p style="padding: 20px; text-align: center; color: #7f8c8d;">No tasks match the selected filters</p>';
                return;
            }
            
            const dates = filteredTasks.flatMap(t => [t.start_date, t.end_date]).filter(Boolean);
            const minDate = new Date(Math.min(...dates.map(d => new Date(d))));
            const maxDate = new Date(Math.max(...dates.map(d => new Date(d))));
            const totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24);
            
            filteredTasks.forEach(task => {
                const row = document.createElement('div');
                row.className = 'task-row';
                
                const label = document.createElement('div');
                label.className = 'task-label';
                
                const statusClass = `status-${(task.status || 'default').toLowerCase().replace(/\s+/g, '-')}`;
                label.innerHTML = `
                    <div class="task-name">
                        ${task.name || 'Untitled'}
                        ${task.status ? `<span class="status-badge ${statusClass}">${task.status}</span>` : ''}
                    </div>
                    <div class="task-info">
                        ${task.category || 'No category'} • 
                        ${formatDate(task.start_date)} - ${formatDate(task.end_date)}
                    </div>
                `;
                
                const track = document.createElement('div');
                track.className = 'timeline-track';
                
                const startDate = new Date(task.start_date);
                const endDate = new Date(task.end_date);
                const startOffset = ((startDate - minDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                const duration = ((endDate - startDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                
                const bar = document.createElement('div');
                bar.className = `task-bar category-${getCategoryClass(task.category)}`;
                bar.style.left = `${startOffset}%`;
                bar.style.width = `${Math.max(duration, 2)}%`;
                
                const progress = task.progress ? Math.round(task.progress * 100) : 0;
                bar.textContent = progress > 0 ? `${progress}%` : '';
                
                bar.addEventListener('mouseenter', (e) => showTooltip(e, task));
                bar.addEventListener('mouseleave', hideTooltip);
                
                track.appendChild(bar);
                row.appendChild(label);
                row.appendChild(track);
                timeline.appendChild(row);
            });
        }
        
        function getCategoryClass(category) {
            if (!category) return 'default';
            const normalized = category.toLowerCase().replace(/\s+/g, '-');
            if (normalized.includes('fundraising')) return 'fundraising';
            if (normalized.includes('technology')) return 'technology';
            if (normalized.includes('milestone') || normalized.includes('bd')) return 'milestones';
            if (normalized.includes('ops')) return 'ops';
            if (normalized.includes('work')) return 'work';
            return 'default';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        function showTooltip(e, task) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'block';
            tooltip.style.left = (e.pageX + 15) + 'px';
            tooltip.style.top = (e.pageY + 15) + 'px';
            
            let content = `<div class="tooltip-title">${task.name || 'Untitled'}</div>`;
            if (task.category) content += `<div class="tooltip-row"><strong>Category:</strong> ${task.category}</div>`;
            if (task.status) content += `<div class="tooltip-row"><strong>Status:</strong> ${task.status}</div>`;
            if (task.priority) content += `<div class="tooltip-row"><strong>Priority:</strong> ${task.priority}</div>`;
            if (task.start_date) content += `<div class="tooltip-row"><strong>Start:</strong> ${formatDate(task.start_date)}</div>`;
            if (task.end_date) content += `<div class="tooltip-row"><strong>End:</strong> ${formatDate(task.end_date)}</div>`;
            if (task.assigned_to && task.assigned_to.length > 0) {
                content += `<div class="tooltip-row"><strong>Assigned:</strong> ${task.assigned_to.join(', ')}</div>`;
            }
            if (task.one_time_cost) content += `<div class="tooltip-row"><strong>One-Time Cost:</strong> $${task.one_time_cost.toLocaleString()}</div>`;
            if (task.monthly_cost) content += `<div class="tooltip-row"><strong>Monthly Cost:</strong> $${task.monthly_cost.toLocaleString()}/mo</div>`;
            if (task.progress) content += `<div class="tooltip-row"><strong>Progress:</strong> ${Math.round(task.progress * 100)}%</div>`;
            
            tooltip.innerHTML = content;
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }
        
        function renderStats() {
            const stats = document.getElementById('stats');
            
            const totalTasks = ganttData.tasks.length;
            const withDates = ganttData.tasks.filter(t => t.start_date && t.end_date).length;
            const inProgress = ganttData.tasks.filter(t => t.status === 'In Progress').length;
            const completed = ganttData.tasks.filter(t => t.status === 'Completed').length;
            
            const totalOneTime = ganttData.tasks.reduce((sum, t) => sum + (t.one_time_cost || 0), 0);
            const totalMonthly = ganttData.tasks.reduce((sum, t) => sum + (t.monthly_cost || 0), 0);
            
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Tasks</div>
                    <div class="stat-value">${totalTasks}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">With Timeline</div>
                    <div class="stat-value">${withDates}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">In Progress</div>
                    <div class="stat-value">${inProgress}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value">${completed}</div>
                </div>
                ${totalOneTime > 0 ? `
                <div class="stat-card">
                    <div class="stat-label">One-Time Costs</div>
                    <div class="stat-value">$${(totalOneTime/1000).toFixed(0)}K</div>
                </div>` : ''}
                ${totalMonthly > 0 ? `
                <div class="stat-card">
                    <div class="stat-label">Monthly Costs</div>
                    <div class="stat-value">$${(totalMonthly/1000).toFixed(0)}K/mo</div>
                </div>` : ''}
            `;
        }
        
        loadData();
    </script>
</body>
</html>

